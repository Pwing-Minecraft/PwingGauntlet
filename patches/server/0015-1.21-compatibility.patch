From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: kyngs <kyngs@users.noreply.github.com>
Date: Tue, 9 Jul 2024 02:00:22 +0200
Subject: [PATCH] 1.21 compatibility


diff --git a/src/main/java/com/infernalsuite/asp/SlimeNMSBridgeImpl.java b/src/main/java/com/infernalsuite/asp/SlimeNMSBridgeImpl.java
index 5d7afcb8e90bde6fd5aa3c1a10917f4fdb78ee3a..8c80b611c00ac09d9d45db5a712435c6534f937a 100644
--- a/src/main/java/com/infernalsuite/asp/SlimeNMSBridgeImpl.java
+++ b/src/main/java/com/infernalsuite/asp/SlimeNMSBridgeImpl.java
@@ -212,7 +212,7 @@ public class SlimeNMSBridgeImpl implements SlimeNMSBridge {
             default -> throw new IllegalArgumentException("Unknown dimension supplied");
         };
 
-        ResourceKey<Level> worldKey = dimensionOverride == null ? ResourceKey.create(Registries.DIMENSION, new ResourceLocation(worldName.toLowerCase(Locale.ENGLISH))) : dimensionOverride;
+        ResourceKey<Level> worldKey = dimensionOverride == null ? ResourceKey.create(Registries.DIMENSION, ResourceLocation.parse(worldName.toLowerCase(Locale.ENGLISH))) : dimensionOverride;
         LevelStem stem = MinecraftServer.getServer().registries().compositeAccess().registryOrThrow(Registries.LEVEL_STEM).get(dimension);
 
         SlimeLevelInstance level;
diff --git a/src/main/java/com/infernalsuite/asp/level/ChunkDataLoadTask.java b/src/main/java/com/infernalsuite/asp/level/ChunkDataLoadTask.java
index bf44132f7614832119f798a2418e2014ec378cf9..2f0e34e105a27b12eb28dfc2b3c3b6590d76cbb2 100644
--- a/src/main/java/com/infernalsuite/asp/level/ChunkDataLoadTask.java
+++ b/src/main/java/com/infernalsuite/asp/level/ChunkDataLoadTask.java
@@ -1,12 +1,12 @@
 package com.infernalsuite.asp.level;
 
 import ca.spottedleaf.concurrentutil.executor.standard.PrioritisedExecutor;
+import ca.spottedleaf.moonrise.patches.chunk_system.scheduling.ChunkTaskScheduler;
+import ca.spottedleaf.moonrise.patches.chunk_system.scheduling.task.ChunkLoadTask;
+import ca.spottedleaf.moonrise.patches.chunk_system.scheduling.task.GenericDataLoadTask;
 import com.infernalsuite.asp.Converter;
 import com.infernalsuite.asp.api.world.SlimeChunk;
 import com.mojang.logging.LogUtils;
-import io.papermc.paper.chunk.system.scheduling.ChunkLoadTask;
-import io.papermc.paper.chunk.system.scheduling.ChunkTaskScheduler;
-import io.papermc.paper.chunk.system.scheduling.GenericDataLoadTask;
 import net.minecraft.nbt.CompoundTag;
 import net.minecraft.server.level.ServerLevel;
 import net.minecraft.world.level.ChunkPos;
diff --git a/src/main/java/com/infernalsuite/asp/level/FastChunkPruner.java b/src/main/java/com/infernalsuite/asp/level/FastChunkPruner.java
index 10bfcb7250c01c8361375c4d9b34d2b0ae17257d..7f86b1922f179a3ff9b4238ab2da5aea5dde5564 100644
--- a/src/main/java/com/infernalsuite/asp/level/FastChunkPruner.java
+++ b/src/main/java/com/infernalsuite/asp/level/FastChunkPruner.java
@@ -1,9 +1,9 @@
 package com.infernalsuite.asp.level;
 
+import ca.spottedleaf.moonrise.patches.chunk_system.level.entity.ChunkEntitySlices;
 import com.infernalsuite.asp.api.world.SlimeWorld;
 import com.infernalsuite.asp.api.world.properties.SlimeProperties;
 import com.infernalsuite.asp.api.world.properties.SlimePropertyMap;
-import io.papermc.paper.world.ChunkEntitySlices;
 import net.minecraft.world.level.chunk.LevelChunk;
 import net.minecraft.world.level.chunk.LevelChunkSection;
 
diff --git a/src/main/java/com/infernalsuite/asp/level/NMSSlimeChunk.java b/src/main/java/com/infernalsuite/asp/level/NMSSlimeChunk.java
index 7b31aba65e30fdef7a3eeb96cd899e6be6839aa9..844d23310b2b38cc9f6e2ae1636ba8a485c07999 100644
--- a/src/main/java/com/infernalsuite/asp/level/NMSSlimeChunk.java
+++ b/src/main/java/com/infernalsuite/asp/level/NMSSlimeChunk.java
@@ -1,17 +1,16 @@
 package com.infernalsuite.asp.level;
 
+import ca.spottedleaf.moonrise.patches.chunk_system.level.entity.ChunkEntitySlices;
 import com.flowpowered.nbt.CompoundMap;
 import com.flowpowered.nbt.CompoundTag;
 import com.flowpowered.nbt.LongArrayTag;
 import com.google.common.collect.Lists;
 import com.infernalsuite.asp.Converter;
-import com.infernalsuite.asp.skeleton.SlimeChunkSectionSkeleton;
 import com.infernalsuite.asp.api.utils.NibbleArray;
 import com.infernalsuite.asp.api.world.SlimeChunk;
 import com.infernalsuite.asp.api.world.SlimeChunkSection;
-import com.mojang.logging.LogUtils;
+import com.infernalsuite.asp.skeleton.SlimeChunkSectionSkeleton;
 import com.mojang.serialization.Codec;
-import io.papermc.paper.world.ChunkEntitySlices;
 import net.minecraft.core.Holder;
 import net.minecraft.core.Registry;
 import net.minecraft.core.SectionPos;
@@ -26,7 +25,10 @@ import net.minecraft.world.level.block.Block;
 import net.minecraft.world.level.block.Blocks;
 import net.minecraft.world.level.block.entity.BlockEntity;
 import net.minecraft.world.level.block.state.BlockState;
-import net.minecraft.world.level.chunk.*;
+import net.minecraft.world.level.chunk.LevelChunk;
+import net.minecraft.world.level.chunk.LevelChunkSection;
+import net.minecraft.world.level.chunk.PalettedContainer;
+import net.minecraft.world.level.chunk.PalettedContainerRO;
 import net.minecraft.world.level.chunk.storage.ChunkSerializer;
 import net.minecraft.world.level.levelgen.Heightmap;
 import net.minecraft.world.level.lighting.LevelLightEngine;
diff --git a/src/main/java/com/infernalsuite/asp/level/SlimeChunkConverter.java b/src/main/java/com/infernalsuite/asp/level/SlimeChunkConverter.java
index 6807767a2067b62558f749da0c25f184082d0769..d04ad95b65f764560aa1ca8c7137f951ed474003 100644
--- a/src/main/java/com/infernalsuite/asp/level/SlimeChunkConverter.java
+++ b/src/main/java/com/infernalsuite/asp/level/SlimeChunkConverter.java
@@ -1,6 +1,7 @@
 package com.infernalsuite.asp.level;
 
-import ca.spottedleaf.starlight.common.light.SWMRNibbleArray;
+import ca.spottedleaf.moonrise.patches.starlight.light.SWMRNibbleArray;
+import ca.spottedleaf.moonrise.patches.starlight.light.StarLightEngine;
 import com.flowpowered.nbt.CompoundMap;
 import com.flowpowered.nbt.CompoundTag;
 import com.flowpowered.nbt.LongArrayTag;
@@ -15,8 +16,6 @@ import net.minecraft.core.Holder;
 import net.minecraft.core.Registry;
 import net.minecraft.core.registries.Registries;
 import net.minecraft.nbt.NbtOps;
-import net.minecraft.world.entity.Entity;
-import net.minecraft.world.entity.EntityType;
 import net.minecraft.world.level.ChunkPos;
 import net.minecraft.world.level.biome.Biome;
 import net.minecraft.world.level.biome.Biomes;
@@ -28,6 +27,7 @@ import net.minecraft.world.level.chunk.LevelChunk;
 import net.minecraft.world.level.chunk.LevelChunkSection;
 import net.minecraft.world.level.chunk.PalettedContainer;
 import net.minecraft.world.level.chunk.UpgradeData;
+import net.minecraft.world.level.chunk.status.ChunkStatusTasks;
 import net.minecraft.world.level.chunk.storage.ChunkSerializer;
 import net.minecraft.world.level.levelgen.Heightmap;
 import net.minecraft.world.level.material.Fluid;
@@ -48,8 +48,8 @@ public class SlimeChunkConverter {
         // Chunk sections
         LevelChunkSection[] sections = new LevelChunkSection[instance.getSectionsCount()];
 
-        SWMRNibbleArray[] blockNibbles = ca.spottedleaf.starlight.common.light.StarLightEngine.getFilledEmptyLight(instance);
-        SWMRNibbleArray[] skyNibbles = ca.spottedleaf.starlight.common.light.StarLightEngine.getFilledEmptyLight(instance);
+        SWMRNibbleArray[] blockNibbles = StarLightEngine.getFilledEmptyLight(instance);
+        SWMRNibbleArray[] skyNibbles = StarLightEngine.getFilledEmptyLight(instance);
         instance.getServer().scheduleOnMain(() -> {
             instance.getLightEngine().retainData(pos, true);
         });
@@ -111,7 +111,7 @@ public class SlimeChunkConverter {
             List<CompoundTag> entities = chunk.getEntities();
 
             if (entities != null) {
-                net.minecraft.server.level.ChunkMap.postLoadProtoChunk(instance, entities.stream()
+                ChunkStatusTasks.postLoadProtoChunk(instance, entities.stream()
                         .map(flowTag -> (net.minecraft.nbt.CompoundTag) Converter.convertTag(flowTag)).toList(), nmsChunk.getPos());
             }
         };
@@ -147,13 +147,13 @@ public class SlimeChunkConverter {
         }
 
         // Height Maps
-        EnumSet<Heightmap.Types> heightMapTypes = nmsChunk.getStatus().heightmapsAfter();
+        EnumSet<Heightmap.Types> heightMapTypes = nmsChunk.getPersistedStatus().heightmapsAfter();
         CompoundMap heightMaps = chunk.getHeightMaps().getValue();
         EnumSet<Heightmap.Types> unsetHeightMaps = EnumSet.noneOf(Heightmap.Types.class);
 
         // Light
-        nmsChunk.setBlockNibbles(blockNibbles);
-        nmsChunk.setSkyNibbles(skyNibbles);
+        nmsChunk.starlight$setBlockNibbles(blockNibbles);
+        nmsChunk.starlight$setSkyNibbles(skyNibbles);
 
         for (Heightmap.Types type : heightMapTypes) {
             String name = type.getSerializedName();
diff --git a/src/main/java/com/infernalsuite/asp/level/SlimeLevelInstance.java b/src/main/java/com/infernalsuite/asp/level/SlimeLevelInstance.java
index d6e5eac7732f32cabd6ed5ac6b10af20074a39b8..33af1d7e671c5aeb06482038e205efc831641ec0 100644
--- a/src/main/java/com/infernalsuite/asp/level/SlimeLevelInstance.java
+++ b/src/main/java/com/infernalsuite/asp/level/SlimeLevelInstance.java
@@ -1,17 +1,15 @@
 package com.infernalsuite.asp.level;
 
 import ca.spottedleaf.concurrentutil.executor.standard.PrioritisedExecutor;
+import ca.spottedleaf.moonrise.patches.chunk_system.scheduling.ChunkTaskScheduler;
+import ca.spottedleaf.moonrise.patches.chunk_system.scheduling.task.ChunkLoadTask;
+import ca.spottedleaf.moonrise.patches.chunk_system.scheduling.task.GenericDataLoadTask;
 import com.google.common.util.concurrent.ThreadFactoryBuilder;
-import com.infernalsuite.asp.Converter;
-import com.infernalsuite.asp.serialization.slime.SlimeSerializer;
-import com.infernalsuite.asp.api.world.SlimeChunk;
 import com.infernalsuite.asp.api.world.SlimeWorld;
 import com.infernalsuite.asp.api.world.SlimeWorldInstance;
 import com.infernalsuite.asp.api.world.properties.SlimeProperties;
 import com.infernalsuite.asp.api.world.properties.SlimePropertyMap;
-import io.papermc.paper.chunk.system.scheduling.ChunkLoadTask;
-import io.papermc.paper.chunk.system.scheduling.ChunkTaskScheduler;
-import io.papermc.paper.chunk.system.scheduling.GenericDataLoadTask;
+import com.infernalsuite.asp.serialization.slime.SlimeSerializer;
 import net.minecraft.core.BlockPos;
 import net.minecraft.core.Holder;
 import net.minecraft.core.registries.Registries;
@@ -24,8 +22,6 @@ import net.minecraft.util.ProgressListener;
 import net.minecraft.util.Unit;
 import net.minecraft.util.datafix.DataFixers;
 import net.minecraft.world.Difficulty;
-import net.minecraft.world.entity.EntityType;
-import net.minecraft.world.level.ChunkPos;
 import net.minecraft.world.level.biome.Biome;
 import net.minecraft.world.level.chunk.ChunkAccess;
 import net.minecraft.world.level.chunk.ChunkGenerator;
@@ -42,7 +38,6 @@ import org.spigotmc.AsyncCatcher;
 import java.io.IOException;
 import java.nio.file.Files;
 import java.nio.file.Path;
-import java.util.ArrayList;
 import java.util.Collections;
 import java.util.UUID;
 import java.util.concurrent.CompletableFuture;
@@ -51,7 +46,6 @@ import java.util.concurrent.Executors;
 import java.util.concurrent.Future;
 import java.util.function.Consumer;
 import java.util.logging.Level;
-import java.util.stream.Collectors;
 
 public class SlimeLevelInstance extends ServerLevel {
 
@@ -106,7 +100,7 @@ public class SlimeLevelInstance extends ServerLevel {
     @Override
     public ChunkGenerator getGenerator(SlimeBootstrap slimeBootstrap) {
         String biomeStr = slimeBootstrap.initial().getPropertyMap().getValue(SlimeProperties.DEFAULT_BIOME);
-        ResourceKey<Biome> biomeKey = ResourceKey.create(Registries.BIOME, new ResourceLocation(biomeStr));
+        ResourceKey<Biome> biomeKey = ResourceKey.create(Registries.BIOME, ResourceLocation.parse(biomeStr));
         Holder<Biome> defaultBiome = MinecraftServer.getServer().registryAccess().registryOrThrow(Registries.BIOME).getHolder(biomeKey).orElseThrow();
         return new SlimeLevelGenerator(defaultBiome);
     }
@@ -144,12 +138,13 @@ public class SlimeLevelInstance extends ServerLevel {
         return CompletableFuture.completedFuture(null);
     }
 
+    /*
     @Override
     public void saveIncrementally(boolean doFull) {
         if (doFull) {
             this.save(null, false, false);
         }
-    }
+    }*/ // Most likely unused - kyngs
 
     private Future<?> saveInternal() {
         synchronized (saveLock) { // Don't want to save the SlimeWorld from multiple threads simultaneously
@@ -180,6 +175,7 @@ public class SlimeLevelInstance extends ServerLevel {
         return new ChunkDataLoadTask(task, scheduler, world, chunkX, chunkZ, priority, onRun);
     }
 
+    /*
     public void loadEntities(int chunkX, int chunkZ) {
         SlimeChunk slimeChunk = this.slimeInstance.getChunk(chunkX, chunkZ);
         if (slimeChunk != null) {
@@ -191,7 +187,7 @@ public class SlimeLevelInstance extends ServerLevel {
                             .toList()
             ), new ChunkPos(chunkX, chunkZ));
         }
-    }
+    }*/ // Most likely unused - kyngs
 
     @Override
     public void setDefaultSpawnPos(BlockPos pos, float angle) {
diff --git a/src/main/java/net/minecraft/world/level/chunk/LevelChunk.java b/src/main/java/net/minecraft/world/level/chunk/LevelChunk.java
index 4640baec5bed6c2d53cc0f8ca1d273cc115abe9b..589cb65f79bb05ee8c44b526c707e81dc02a4761 100644
--- a/src/main/java/net/minecraft/world/level/chunk/LevelChunk.java
+++ b/src/main/java/net/minecraft/world/level/chunk/LevelChunk.java
@@ -1,5 +1,7 @@
 package net.minecraft.world.level.chunk;
 
+import ca.spottedleaf.moonrise.patches.chunk_system.scheduling.ChunkHolderManager;
+import ca.spottedleaf.moonrise.patches.chunk_system.scheduling.NewChunkHolder;
 import com.google.common.collect.ImmutableList;
 import com.google.common.collect.Maps;
 import com.google.common.collect.UnmodifiableIterator;
@@ -23,6 +25,7 @@ import net.minecraft.core.registries.Registries;
 import net.minecraft.nbt.CompoundTag;
 import net.minecraft.network.FriendlyByteBuf;
 import net.minecraft.network.protocol.game.ClientboundLevelChunkPacketData;
+import net.minecraft.server.level.ChunkHolder;
 import net.minecraft.server.level.FullChunkStatus;
 import net.minecraft.server.level.ServerLevel;
 import net.minecraft.util.profiling.Profiler;
@@ -322,6 +325,12 @@ public class LevelChunk extends ChunkAccess implements ca.spottedleaf.moonrise.p
         }
     }
 
+    // ASWM start - maintain binary compatibility with 1.20.6
+    public NewChunkHolder getChunkHolder() {
+        return this.level.moonrise$getChunkTaskScheduler().chunkHolderManager.getChunkHolder(chunkPos.x, chunkPos.z);
+    }
+    // ASWM end
+
     // Paper start - If loaded util
     @Override
     public final FluidState getFluidIfLoaded(BlockPos blockposition) {
diff --git a/src/main/java/net/minecraft/world/level/chunk/storage/SerializableChunkData.java b/src/main/java/net/minecraft/world/level/chunk/storage/SerializableChunkData.java
index 6f482bf045cf7a14dceb5673d9d19ee87b7c03a8..cb0c551bb3899201e2ca55a72babc76b3704501b 100644
--- a/src/main/java/net/minecraft/world/level/chunk/storage/SerializableChunkData.java
+++ b/src/main/java/net/minecraft/world/level/chunk/storage/SerializableChunkData.java
@@ -469,7 +469,7 @@ public record SerializableChunkData(Registry<Biome> biomeRegistry, ChunkPos chun
         SerializableChunkData.LOGGER.error("Recoverable errors when loading section [{}, {}, {}]: {}", new Object[]{chunkPos.x, y, chunkPos.z, message});
     }
 
-    private static Codec<PalettedContainerRO<Holder<Biome>>> makeBiomeCodec(Registry<Biome> biomeRegistry) {
+    public static Codec<PalettedContainerRO<Holder<Biome>>> makeBiomeCodec(Registry<Biome> biomeRegistry) {
         return PalettedContainer.codecRO(biomeRegistry.asHolderIdMap(), biomeRegistry.holderByNameCodec(), PalettedContainer.Strategy.SECTION_BIOMES, biomeRegistry.getOrThrow(Biomes.PLAINS));
     }
 
