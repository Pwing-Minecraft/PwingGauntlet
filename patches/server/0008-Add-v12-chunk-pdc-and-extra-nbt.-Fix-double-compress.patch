From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: kyngs <kyngs@users.noreply.github.com>
Date: Tue, 19 Dec 2023 21:47:15 +0100
Subject: [PATCH] Add v12, chunk pdc and extra nbt. Fix double compression on
 tile entities and entities. Fix horrible bug which made chunks go poof.


diff --git a/src/main/java/com/infernalsuite/asp/SimpleDataFixerConverter.java b/src/main/java/com/infernalsuite/asp/SimpleDataFixerConverter.java
index eb426271140d9e36b09ef96e4c59c21d265a5edc..36d13632916b8e93d5f28c29ea80ef4ac87e6c89 100644
--- a/src/main/java/com/infernalsuite/asp/SimpleDataFixerConverter.java
+++ b/src/main/java/com/infernalsuite/asp/SimpleDataFixerConverter.java
@@ -70,11 +70,12 @@ class SimpleDataFixerConverter implements SlimeWorldReader<SlimeWorld> {
 
             chunks.put(chunkPos, new SlimeChunkSkeleton(
                     chunk.getX(),
-                    chunk.getX(),
+                    chunk.getZ(),
                     sections,
                     chunk.getHeightMaps(),
                     blockEntities,
-                    entities
+                    entities,
+                    chunk.getExtraData()
             ));
 
         }
diff --git a/src/main/java/com/infernalsuite/asp/level/NMSSlimeChunk.java b/src/main/java/com/infernalsuite/asp/level/NMSSlimeChunk.java
index 9a6e901b394d1e7740e616a33e6c251ae1d7e0e0..dc34469712bdd84d4b17dfd5e9657c3a12420241 100644
--- a/src/main/java/com/infernalsuite/asp/level/NMSSlimeChunk.java
+++ b/src/main/java/com/infernalsuite/asp/level/NMSSlimeChunk.java
@@ -67,9 +67,11 @@ public class NMSSlimeChunk implements SlimeChunk {
     }
 
     private LevelChunk chunk;
+    private CompoundTag extra;
 
-    public NMSSlimeChunk(LevelChunk chunk) {
+    public NMSSlimeChunk(LevelChunk chunk, SlimeChunk reference) {
         this.chunk = chunk;
+        this.extra = reference == null ? new CompoundTag("", new CompoundMap()) : reference.getExtraData();
     }
 
     @Override
@@ -192,6 +194,11 @@ public class NMSSlimeChunk implements SlimeChunk {
         });
     }
 
+    @Override
+    public CompoundTag getExtraData() {
+        return extra;
+    }
+
     public LevelChunk getChunk() {
         return chunk;
     }
diff --git a/src/main/java/com/infernalsuite/asp/level/NMSSlimeWorld.java b/src/main/java/com/infernalsuite/asp/level/NMSSlimeWorld.java
index 76ee216925d9ced3c9bf1e7e8e1d8b80ca9f8e50..bd2f8da46d4a04f2777086a416015563f3b06cdf 100644
--- a/src/main/java/com/infernalsuite/asp/level/NMSSlimeWorld.java
+++ b/src/main/java/com/infernalsuite/asp/level/NMSSlimeWorld.java
@@ -45,14 +45,14 @@ public class NMSSlimeWorld implements SlimeWorld {
             return null;
         }
 
-        return new NMSSlimeChunk(chunk);
+        return new NMSSlimeChunk(chunk, memoryWorld.getChunk(x, z));
     }
 
     @Override
     public Collection<SlimeChunk> getChunkStorage() {
         List<ChunkHolder> chunks = io.papermc.paper.chunk.system.ChunkSystem.getVisibleChunkHolders(this.instance); // Paper
         return chunks.stream().map(ChunkHolder::getFullChunkNow).filter(Objects::nonNull)
-                .map(NMSSlimeChunk::new)
+                .map((chunkLevel) -> new NMSSlimeChunk(chunkLevel, memoryWorld.getChunk(chunkLevel.getPos().x, chunkLevel.getPos().z))) // This sucks, is there a better way?
                 .collect(Collectors.toList());
     }
 
diff --git a/src/main/java/com/infernalsuite/asp/level/SafeNmsChunkWrapper.java b/src/main/java/com/infernalsuite/asp/level/SafeNmsChunkWrapper.java
index 025da4dd831f9b8b35000be7de493d44caa41003..7dd1c52f718866f8918c30de9cc71d151eddc958 100644
--- a/src/main/java/com/infernalsuite/asp/level/SafeNmsChunkWrapper.java
+++ b/src/main/java/com/infernalsuite/asp/level/SafeNmsChunkWrapper.java
@@ -62,6 +62,15 @@ public class SafeNmsChunkWrapper implements SlimeChunk {
         return this.wrapper.getEntities();
     }
 
+    @Override
+    public CompoundTag getExtraData() {
+        if (shouldDefaultBackToSlimeChunk()) {
+            return this.safety.getExtraData();
+        }
+
+        return this.wrapper.getExtraData();
+    }
+
     /*
 Slime chunks can still be requested but not actually loaded, this caused
 some things to not properly save because they are not "loaded" into the chunk.
diff --git a/src/main/java/com/infernalsuite/asp/level/SlimeChunkConverter.java b/src/main/java/com/infernalsuite/asp/level/SlimeChunkConverter.java
index 6b38f707b43e1e584c79a6c8d9ec1232ed2901b9..d3289cb71f9ff71d5122ed43e9a0ab40f93c774a 100644
--- a/src/main/java/com/infernalsuite/asp/level/SlimeChunkConverter.java
+++ b/src/main/java/com/infernalsuite/asp/level/SlimeChunkConverter.java
@@ -165,6 +165,13 @@ public class SlimeChunkConverter {
             Heightmap.primeHeightmaps(nmsChunk, unsetHeightMaps);
         }
 
+        net.minecraft.nbt.CompoundTag nmsExtraData = (net.minecraft.nbt.CompoundTag) Converter.convertTag(chunk.getExtraData());
+
+        // Attempt to read PDC from the extra tag
+        if (nmsExtraData.get("ChunkBukkitValues") != null) {
+            nmsChunk.persistentDataContainer.putAll(nmsExtraData.getCompound("ChunkBukkitValues"));
+        }
+
         return nmsChunk;
     }
 }
\ No newline at end of file
diff --git a/src/main/java/com/infernalsuite/asp/level/SlimeInMemoryWorld.java b/src/main/java/com/infernalsuite/asp/level/SlimeInMemoryWorld.java
index 35d0dd30b3c91b423c03a8f1682a422bf5eb8bc1..15340aecc97a30767340f7837a21decc74afbe9c 100644
--- a/src/main/java/com/infernalsuite/asp/level/SlimeInMemoryWorld.java
+++ b/src/main/java/com/infernalsuite/asp/level/SlimeInMemoryWorld.java
@@ -1,6 +1,7 @@
 package com.infernalsuite.asp.level;
 
 import com.flowpowered.nbt.CompoundTag;
+import com.flowpowered.nbt.Tag;
 import com.infernalsuite.asp.ChunkPos;
 import com.infernalsuite.asp.Converter;
 import com.infernalsuite.asp.api.exceptions.WorldAlreadyExistsException;
@@ -88,11 +89,11 @@ public class SlimeInMemoryWorld implements SlimeWorld, SlimeWorldInstance {
             levelChunk = new SlimeChunkLevel(this.instance, pos, UpgradeData.EMPTY, blockLevelChunkTicks, fluidLevelChunkTicks,
                     0L, null, null, null);
 
-            chunk = new NMSSlimeChunk(levelChunk);
+            chunk = new NMSSlimeChunk(levelChunk, getChunk(x, z));
 
         } else {
             levelChunk = SlimeChunkConverter.deserializeSlimeChunk(this.instance, chunk);
-            chunk = new SafeNmsChunkWrapper(new NMSSlimeChunk(levelChunk), chunk);
+            chunk = new SafeNmsChunkWrapper(new NMSSlimeChunk(levelChunk, chunk), chunk);
         }
         this.chunkStorage.put(new ChunkPos(x, z), chunk);
 
@@ -105,7 +106,7 @@ public class SlimeInMemoryWorld implements SlimeWorld, SlimeWorldInstance {
         final int x = providedChunk.locX;
         final int z = providedChunk.locZ;
 
-        SlimeChunk chunk = new NMSSlimeChunk(providedChunk);
+        SlimeChunk chunk = new NMSSlimeChunk(providedChunk, getChunk(x, z));
 
         if (FastChunkPruner.canBePruned(this.liveWorld, providedChunk)) {
             this.chunkStorage.remove(new ChunkPos(x, z));
@@ -114,7 +115,7 @@ public class SlimeInMemoryWorld implements SlimeWorld, SlimeWorldInstance {
 
         this.chunkStorage.put(new ChunkPos(x, z),
                 new SlimeChunkSkeleton(chunk.getX(), chunk.getZ(), chunk.getSections(),
-                        chunk.getHeightMaps(), chunk.getTileEntities(), chunk.getEntities()));
+                        chunk.getHeightMaps(), chunk.getTileEntities(), chunk.getEntities(), chunk.getExtraData()));
     }
 
     @Override
@@ -227,13 +228,20 @@ public class SlimeInMemoryWorld implements SlimeWorld, SlimeWorldInstance {
                         continue;
                     }
 
+                    // Serialize Bukkit Values (PDC)
+
+                    Tag<?> flowTag = Converter.convertTag("ChunkBukkitValues", chunk.persistentDataContainer.toTagCompound());
+
+                    clonedChunk.getExtraData().getValue().put(flowTag);
+
                     clonedChunk = new SlimeChunkSkeleton(
                             clonedChunk.getX(),
                             clonedChunk.getZ(),
                             clonedChunk.getSections(),
                             clonedChunk.getHeightMaps(),
                             clonedChunk.getTileEntities(),
-                            clonedChunk.getEntities()
+                            clonedChunk.getEntities(),
+                            clonedChunk.getExtraData()
                     );
                 }
             }
diff --git a/src/main/java/com/infernalsuite/asp/level/SlimeLevelInstance.java b/src/main/java/com/infernalsuite/asp/level/SlimeLevelInstance.java
index b8d789c93f7fef253d6ab0c35dcee37460f275eb..5e3426a632d471aff38de29645fdee291c4931ae 100644
--- a/src/main/java/com/infernalsuite/asp/level/SlimeLevelInstance.java
+++ b/src/main/java/com/infernalsuite/asp/level/SlimeLevelInstance.java
@@ -151,9 +151,7 @@ public class SlimeLevelInstance extends ServerLevel {
             Bukkit.getLogger().log(Level.INFO, "Saving world " + this.slimeInstance.getName() + "...");
             long start = System.currentTimeMillis();
 
-            Bukkit.getLogger().log(Level.INFO, "CONVERTING NMS -> SKELETON");
             SlimeWorld world = this.slimeInstance.getForSerialization();
-            Bukkit.getLogger().log(Level.INFO, "CONVERTED TO SKELETON, PUSHING OFF-THREAD");
             return WORLD_SAVER_SERVICE.submit(() -> {
                 try {
                     byte[] serializedWorld = SlimeSerializer.serialize(world);
